<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão Simples - Portal do Cliente</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f6f8fa; }
    header { background: #0d6efd; color: #fff; padding: 16px; }
    main { max-width: 900px; margin: 24px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    h1, h2 { margin: 0 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; }
    input, select, button, textarea { width: 100%; padding: 10px; border: 1px solid #ccd; border-radius: 6px; }
    button { background: #0d6efd; color: #fff; cursor: pointer; border: none; }
    button:hover { background: #0b5ed7; }
    .apps { height: 150px; }
    .section { margin-bottom: 24px; }
    .muted { color: #667; font-size: 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: #fafafa; }
  </style>
</head>
<body>
  <header>
    <h1>Gestão Simples - Portal do Cliente</h1>
  </header>

  <main>
    <div class="section">
      <h2>Configurações do Dispositivo</h2>
      <div class="grid">
        <div class="card">
          <label>Email do Responsável</label>
          <input id="email" type="email" placeholder="ex: pai@exemplo.com" />

          <label style="margin-top:12px">Senha do App</label>
          <input id="childPassword" type="text" placeholder="ex: 1234" />

          <label style="margin-top:12px">ID do Dispositivo</label>
          <input id="deviceId" type="text" placeholder="ex: ANDROID-ABC123" />

          <button id="save" style="margin-top:16px">Salvar Configurações</button>
          <p class="muted" style="margin-top:8px">As configurações são salvas localmente neste protótipo.</p>
        </div>

        <div class="card">
          <label>Firebase Config</label>
          <textarea id="firebaseConfig" class="apps" placeholder='Cole aqui o JSON de config do Firebase (web), ex:\n{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
          <button id="connect" style="margin-top:16px">Conectar ao Firebase</button>
          <p class="muted" style="margin-top:8px">Após conectar, use "Aplicar Lista" para escrever no banco.</p>

          <label style="margin-top:12px">Ou carregar arquivo config.local.json</label>
          <input id="configFile" type="file" accept=".json" />
          <button id="loadFile" style="margin-top:8px">Carregar arquivo</button>
          <p class="muted" id="fileNotice" style="margin-top:8px"></p>

          <label>Apps Bloqueados (pacote)</label>
          <textarea id="blocked" class="apps" placeholder="Uma por linha, ex:
com.google.android.youtube
com.instagram.android
com.android.settings
"></textarea>
          <button id="apply" style="margin-top:16px">Aplicar Lista</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Configuração Gerada</h2>
      <pre id="output" class="card" style="white-space:pre-wrap"></pre>
    </div>

    <div class="section">
      <h2>Observações</h2>
      <ul>
        <li>Este é um protótipo estático para demonstrar o fluxo B2C.</li>
        <li>Em produção, estas configurações seriam salvas em um backend (ex: Firebase) e sincronizadas pelo app.</li>
        <li>O app Android já lê senha e lista de apps do armazenamento local.</li>
      </ul>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const email = document.getElementById('email');
    const childPassword = document.getElementById('childPassword');
    const deviceId = document.getElementById('deviceId');
    const blocked = document.getElementById('blocked');
    const output = document.getElementById('output');
    const firebaseConfigInput = document.getElementById('firebaseConfig');
    const configFileInput = document.getElementById('configFile');
    const fileNotice = document.getElementById('fileNotice');
    let db = null;
    let connected = false;

    const load = async () => {
      email.value = localStorage.getItem('gs_email') || '';
      childPassword.value = localStorage.getItem('gs_child_password') || '1234';
      deviceId.value = localStorage.getItem('gs_device_id') || '';
      blocked.value = (JSON.parse(localStorage.getItem('gs_blocked') || '[]')).join('\n');
      render();

      // Tentativa de carregar configuração local sem expor chaves no repositório
      try {
        const resp = await fetch('./config.local.json');
        if (resp.ok) {
          const cfg = await resp.json();
          firebaseConfigInput.value = JSON.stringify(cfg, null, 2);
          const app = initializeApp(cfg);
          db = getDatabase(app);
          connected = true;
          console.log('Firebase conectado via config.local.json');
        }
      } catch (_) {
        // Se aberto via file://, fetch pode falhar; usar upload de arquivo como alternativa
      }

      if (location.protocol === 'file:') {
        fileNotice.textContent = 'Dica: Abrindo como arquivo local. Se o auto-carregamento falhar, use "Carregar arquivo" ou cole o JSON e clique em "Conectar".';
      }
    };

    const render = () => {
      const config = {
        email: email.value,
        childPassword: childPassword.value,
        deviceId: deviceId.value,
        blockedApps: blocked.value.split('\n').map(s => s.trim()).filter(Boolean)
      };
      output.textContent = JSON.stringify(config, null, 2);
    };

    document.getElementById('save').onclick = () => {
      localStorage.setItem('gs_email', email.value);
      localStorage.setItem('gs_child_password', childPassword.value);
      localStorage.setItem('gs_device_id', deviceId.value);
      render();
    };

    document.getElementById('connect').onclick = () => {
      try {
        const cfg = JSON.parse(firebaseConfigInput.value);
        const app = initializeApp(cfg);
        db = getDatabase(app);
        connected = true;
        alert('Conectado ao Firebase!');
      } catch (e) {
        alert('Config inválida');
      }
    };

    document.getElementById('loadFile').onclick = () => {
      const f = configFileInput.files?.[0];
      if (!f) { alert('Selecione um arquivo .json'); return; }
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target?.result;
          const cfg = JSON.parse(text);
          firebaseConfigInput.value = JSON.stringify(cfg, null, 2);
          const app = initializeApp(cfg);
          db = getDatabase(app);
          connected = true;
          alert('Conectado via arquivo config.local.json');
        } catch (err) {
          alert('Arquivo JSON inválido');
        }
      };
      reader.readAsText(f);
    };

    document.getElementById('apply').onclick = () => {
      const list = blocked.value.split('\n').map(s => s.trim()).filter(Boolean);
      localStorage.setItem('gs_blocked', JSON.stringify(list));
      render();
      if (connected && db && deviceId.value) {
        const path = `devices/${deviceId.value}`;
        set(ref(db, path), {
          email: email.value,
          childPassword: childPassword.value,
          blockedApps: list
        }).then(() => alert('Configuração enviada ao Firebase'))
          .catch(() => alert('Falha ao enviar configuração'));
      }
    };

    load();
  </script>
</body>
</html>
